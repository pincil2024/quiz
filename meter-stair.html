<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Tupai ‚Äî Petualangan Tangga Konversi Meter</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&display=swap" rel="stylesheet">
<!-- Add your navbar.css -->
 <link rel="stylesheet" href="/static/css/navbar.css">
  <link rel="stylesheet" href="/static/css/locked.css">

 
  <script>
            fetch('meta.html').then(res => res.text()).then(html => {
            document.head.insertAdjacentHTML('beforeend', html);
            });
        </script>

<script src="/assets/js/premium/global-locking.js"></script>
<script type="module" src="assets/js/firebase-init.js"></script>
<script type="module" src="assets/js/token-manager.client.js"></script>
<script type="module" src="assets/js/navbar.js"></script>

<style>
  :root{
    --bg1:#0f172a;
    --bg2:#1e293b;
    --accent1:#f59e0b;
    --accent2:#10b981;
    --accent3:#3b82f6;
    --text-light:#f1f5f9;
    --text-dark:#0f172a;
    --step-w:180px;
    --step-h:70px;
    --radius:20px;
    --glow:0 0 30px rgba(245, 158, 11, 0.3);
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:"Poppins",system-ui,Roboto,Segoe UI,Arial;
    background: linear-gradient(135deg, var(--bg1), var(--bg2));
    color:var(--text-light);
    min-height:100vh;
    display:flex;
    flex-direction:column;
    padding:0;
  }

  /* OVERRIDE NAVBAR.CSS STYLES FOR SECONDARY HEADER */
  /* Fix for lazy loading images in secondary header */
  .secondaryHeader .lazy {
    opacity: 1 !important;
    background: none !important;
    animation: none !important;
  }
  
  .secondaryHeader img.lazy {
    display: block !important;
    visibility: visible !important;
  }

  /* Ensure images in secondary header are visible */
  .secondaryHeader img {
    opacity: 1 !important;
    visibility: visible !important;
    display: block !important;
  }

  /* Navbar Styles */
  #navbar {
    background: linear-gradient(145deg, rgba(30,41,59,0.95), rgba(15,23,42,0.98));
    padding: 15px 20px;
    border-bottom: 2px solid rgba(255,255,255,0.1);
    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
  }

  /* Secondary Header Styles - More specific to override navbar.css */
  .secondaryHeader {
    background: linear-gradient(145deg, rgba(30,41,59,0.9), rgba(15,23,42,0.95));
    padding: 15px 20px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    border-bottom: 2px solid rgba(255,255,255,0.1);
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    position: relative;
    z-index: 9999;
  }

  .secondaryHeader a {
    transition: transform 0.3s ease;
    display: flex;
    align-items: center;
  }

  .secondaryHeader a:hover {
    transform: scale(1.1);
  }

  .secondaryHeader p {
    margin: 0;
    font-weight: 700;
    font-size: 18px;
    background: linear-gradient(135deg, var(--accent1), var(--accent2));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    text-align: center;
    flex-grow: 1;
  }

  /* Specific styles for secondary header images to override navbar.css */
  .secondaryHeader img.lazy {
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    width: 80px !important;
    height: 80px !important;
    object-fit: contain;
    opacity: 1 !important;
    visibility: visible !important;
    background: transparent !important;
  }

  /* Override any lazy loading animations for these specific images */
  .secondaryHeader .lazy:not(.loaded) {
    background: transparent !important;
    animation: none !important;
  }

  .wrap{
    width:1200px;
    max-width:95vw;
    background: linear-gradient(145deg, rgba(30,41,59,0.95), rgba(15,23,42,0.98));
    border-radius:24px;
    padding:24px;
    box-shadow:0 25px 60px rgba(0,0,0,0.4), inset 0 1px 0 rgba(255,255,255,0.1);
    border:1px solid rgba(255,255,255,0.1);
    backdrop-filter:blur(10px);
    margin: 20px auto;
    flex-grow: 1;
  }
  header{display:flex;gap:16px;align-items:center;margin-bottom:20px;padding-bottom:16px;border-bottom:2px solid rgba(255,255,255,0.1);}
  h1{margin:0;font-size:28px;font-weight:800;background:linear-gradient(135deg, var(--accent1), var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
  p.lead{margin:8px 0 0 0;color:#94a3b8;font-size:14px;font-weight:600;}
  .layout{display:flex;gap:24px;align-items:flex-start;}
  .left{flex:1;min-width:700px;}
  .right{width:350px;}

  /* STAIR AREA - Gaming Style */
  .stair-area{
    position:relative;
    height:580px;
    border-radius:20px;
    padding:24px;
    overflow:visible;
    background: linear-gradient(160deg, rgba(30,41,59,0.8), rgba(15,23,42,0.9));
    border:2px solid rgba(255,255,255,0.1);
    box-shadow:inset 0 0 50px rgba(0,0,0,0.3), 0 20px 40px rgba(0,0,0,0.2);
  }

  /* Steps - Gaming Style */
  .step{
    position:absolute;
    width:var(--step-w);
    height:var(--step-h);
    border-radius:var(--radius);
    display:flex;
    align-items:center;
    justify-content:center;
    font-weight:800;
    font-size:18px;
    color:var(--text-light);
    box-shadow: 0 12px 30px rgba(0,0,0,0.3), inset 0 4px 12px rgba(255,255,255,0.1);
    border:2px solid rgba(255,255,255,0.15);
    text-shadow:0 2px 4px rgba(0,0,0,0.3);
    transition:all 0.3s ease;
  }
  .step:hover{transform:translateY(-2px);box-shadow:0 15px 35px rgba(0,0,0,0.4), inset 0 4px 12px rgba(255,255,255,0.15);}
  
  .step.km  { background: linear-gradient(145deg,#f59e0b,#d97706); left:30px; top:25px; box-shadow:var(--glow), 0 12px 30px rgba(0,0,0,0.3); }
  .step.hm  { background: linear-gradient(145deg,#10b981,#059669); left:105px; top:105px; box-shadow:0 0 25px rgba(16,185,129,0.3), 0 12px 30px rgba(0,0,0,0.3); }
  .step.dam { background: linear-gradient(145deg,#3b82f6,#2563eb); left:180px; top:185px; box-shadow:0 0 25px rgba(59,130,246,0.3), 0 12px 30px rgba(0,0,0,0.3); }
  .step.m   { background: linear-gradient(145deg,#8b5cf6,#7c3aed); left:255px; top:265px; box-shadow:0 0 25px rgba(139,92,246,0.3), 0 12px 30px rgba(0,0,0,0.3); }
  .step.dm  { background: linear-gradient(145deg,#ec4899,#db2777); left:330px; top:345px; box-shadow:0 0 25px rgba(236,72,153,0.3), 0 12px 30px rgba(0,0,0,0.3); }
  .step.cm  { background: linear-gradient(145deg,#06b6d4,#0891b2); left:405px; top:425px; box-shadow:0 0 25px rgba(6,182,212,0.3), 0 12px 30px rgba(0,0,0,0.3); }
  .step.mm  { background: linear-gradient(145deg,#f97316,#ea580c); left:480px; top:505px; box-shadow:0 0 25px rgba(249,115,22,0.3), 0 12px 30px rgba(0,0,0,0.3); }

  .step::after{
    content:"";
    position:absolute;
    left:8px; right:-8px; bottom:-12px;
    height:20px;
    border-radius:12px;
    filter: blur(12px);
    opacity:0.2;
    background: currentColor;
    transform: translateY(6px);
    z-index:-1;
  }

  /* SVG overlay for arrows */
  svg.arrow-layer{
    position:absolute; left:0; top:0; width:100%; height:100%; pointer-events:none; overflow:visible; z-index:45;
  }

  /* arrow path styles - Gaming */
  .curve{ fill:none; stroke:rgba(255,255,255,0.9); stroke-width:5; stroke-linecap:round; stroke-linejoin:round; filter:drop-shadow(0 0 10px rgba(255,255,255,0.3)); }
  .draw{ stroke-dasharray:1000; stroke-dashoffset:1000; transition: stroke-dashoffset 1.2s cubic-bezier(.2,.9,.2,1); }

  /* Operation labels - Gaming */
  .op-label{
    position:absolute; transform:translate(-50%,-50%);
    background: linear-gradient(145deg, rgba(30,41,59,0.95), rgba(15,23,42,0.98));
    padding:8px 16px; border-radius:16px;
    font-weight:800; font-size:16px; 
    box-shadow:0 8px 25px rgba(0,0,0,0.3), 0 0 15px rgba(255,255,255,0.1);
    border:2px solid rgba(255,255,255,0.15);
    color:var(--accent1);
    opacity:0; transition:all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    pointer-events:none; z-index:48;
    text-shadow:0 0 10px currentColor;
  }
  .op-label.show{ opacity:1; transform:translate(-50%,-70%) scale(1.1); }

  /* Squirrel character - Enhanced */
  .squirrel{
    position:absolute; width:100px; height:100px; transform-origin:center bottom; z-index:50;
    transition:all 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
    will-change:left,top,transform;
    filter:drop-shadow(0 5px 15px rgba(0,0,0,0.3));
  }
  /* Enhanced animations */
  @keyframes hopBounce{ 
    0%{transform:translateY(0) scale(1);} 
    30%{transform:translateY(-25px) scale(1.1);} 
    60%{transform:translateY(0) scale(1);} 
    100%{transform:translateY(0) scale(1);} 
  }
  @keyframes tailWiggle{ 
    0%{transform:rotate(0);} 
    25%{transform:rotate(12deg);} 
    50%{transform:rotate(-8deg);} 
    75%{transform:rotate(6deg);} 
    100%{transform:rotate(0);} 
  }
  @keyframes squirrelGlow{
    0%{filter:drop-shadow(0 5px 15px rgba(245,158,11,0.4));}
    50%{filter:drop-shadow(0 5px 25px rgba(245,158,11,0.6));}
    100%{filter:drop-shadow(0 5px 15px rgba(245,158,11,0.4));}
  }
  .squirrel.hop{ animation: hopBounce 600ms ease, squirrelGlow 600ms ease; }
  .squirrel .tail{ transform-origin:center bottom; animation: tailWiggle 700ms ease; }

  /* Enhanced speech bubble */
  .speech{
    position:absolute; padding:12px 18px; border-radius:18px; 
    background: linear-gradient(145deg, var(--accent2), var(--accent3));
    color:white; font-weight:800; font-size:18px; 
    box-shadow:0 12px 30px rgba(16,185,129,0.3), 0 0 20px rgba(59,130,246,0.4); 
    z-index:60; border:2px solid rgba(255,255,255,0.2);
    transform:translate(-50%, -15px) scale(0.8); opacity:0; 
    transition:all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    pointer-events:none; text-shadow:0 2px 4px rgba(0,0,0,0.3);
  }
  .speech.show{ opacity:1; transform:translate(-50%, -25px) scale(1.1); }

  /* Gaming UI Panels */
  .panel{ 
    background: linear-gradient(145deg, rgba(30,41,59,0.9), rgba(15,23,42,0.95));
    border-radius:20px; padding:20px; 
    box-shadow:0 15px 35px rgba(0,0,0,0.2), inset 0 1px 0 rgba(255,255,255,0.1);
    border:2px solid rgba(255,255,255,0.1);
    backdrop-filter:blur(10px);
  }
  .panel-title{
    font-weight:800; margin-bottom:16px; font-size:18px;
    background:linear-gradient(135deg, var(--accent1), var(--text-light));
    -webkit-background-clip:text; -webkit-text-fill-color:transparent;
  }
  
  .controls{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-bottom:12px; }
  label{ color:#a394b8; font-weight:600; font-size:14px; }
  select, button{ 
    padding:12px 16px; border-radius:14px; 
    border:2px solid rgba(255,255,255,0.15); 
    background: linear-gradient(145deg, rgba(215, 225, 227, 0.9), rgba(153, 160, 164, 0.95));
    font-weight:700; color:var(--text-light);
    transition:all 0.3s ease;
    color: #0f172a;
    box-shadow:0 4px 15px rgba(0,0,0,0.2);
  }
  select:hover, button:hover{ border-color:var(--accent1); transform:translateY(-2px); }
  select:focus, button:focus{ outline:none; border-color:var(--accent2); box-shadow:0 0 20px rgba(16,185,129,0.3); }
  
  button.primary{ 
    background:linear-gradient(145deg, var(--accent1), #d97706); 
    color:var(--text-dark); border:none; 
    box-shadow:0 8px 25px rgba(245,158,11,0.3), 0 0 15px rgba(245,158,11,0.2);
    font-weight:800;
  }
  button.primary:hover{ transform:translateY(-3px) scale(1.05); box-shadow:0 12px 30px rgba(245,158,11,0.4), 0 0 20px rgba(245,158,11,0.3); }

  .quick-btn{ 
    background:linear-gradient(145deg, rgba(59,130,246,0.2), rgba(30,41,59,0.8));
    border:2px solid rgba(59,130,246,0.3);
    color:var(--text-light);
  }
  .quick-btn:hover{ border-color:var(--accent3); background:linear-gradient(145deg, rgba(59,130,246,0.3), rgba(30,41,59,0.9)); }

  .reset-btn{ 
    background:linear-gradient(145deg, rgba(239,68,68,0.2), rgba(30,41,59,0.8));
    border:2px solid rgba(239,68,68,0.3);
    color:var(--text-light);
    margin-top:8px;
  }
  .reset-btn:hover{ border-color:#ef4444; background:linear-gradient(145deg, rgba(239,68,68,0.3), rgba(30,41,59,0.9)); }

  /* Responsive */
  @media (max-width:1100px){
    .layout{ flex-direction:column; gap:20px; }
    .left{ min-width:unset; }
    .stair-area{ height:650px; }
    .wrap{ padding:16px; }
    .secondaryHeader p {
      font-size: 16px;
      padding: 0 10px;
    }
    .secondaryHeader img.lazy {
      width: 60px !important;
      height: 60px !important;
    }
  }

  /* Particle effects container */
  .particles{ position:absolute; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index:40; }
</style>
</head>
<body>
  <div id="navbar"></div>
  <!-- Secondary Header -->
  <div id="secondaryHeader" class="secondaryHeader">
    <a href='sdmath.html'>
      <img class="lazy" alt="Kembali" title="Kembali" src="assets/image-mainsukukata/gobackbutton.png" width="80" height="80">
    </a>
    <p>Pengenalan Bangun Datar/Bangun Ruang</p>
    <a href='index.html'>
      <img class="lazy" alt="Home" title="Home" src="assets/icons/favicon.png" width="80" height="80">
    </a>
  </div>

  <div class="wrap">
    <header>
      <div style="width:60px;height:60px;border-radius:16px;background:linear-gradient(145deg,var(--accent1),#d97706);display:flex;align-items:center;justify-content:center;color:var(--text-dark);font-weight:800;font-size:24px;box-shadow:var(--glow);">üêøÔ∏è</div>
      <div>
        <h1>Tupai ‚Äî Petualangan Tangga Konversi Meter</h1>
        <p class="lead">Lihat Tupai melompati tangga konversi! Setiap langkah mengungkap keajaiban konversi metrik.</p>
      </div>
    </header>

    <div class="layout">
      <div class="left">
        <div class="stair-area" id="stairArea">
          <!-- Steps -->
          <div class="step km"  data-unit="km">üöÄ km</div>
          <div class="step hm"  data-unit="hm">üå≤ hm</div>
          <div class="step dam" data-unit="dam">ü™µ dam</div>
          <div class="step m"   data-unit="m">‚≠ê m</div>
          <div class="step dm"  data-unit="dm">üå∞ dm</div>
          <div class="step cm"  data-unit="cm">üêøÔ∏è cm</div>
          <div class="step mm"  data-unit="mm">‚ö° mm</div>

          <!-- SVG overlay -->
          <svg class="arrow-layer" id="svgLayer" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="none">
            <defs>
              <marker id="arrHead" viewBox="0 0 16 16" markerWidth="12" markerHeight="12" refX="8" refY="8" orient="auto">
                <path d="M4 4 L12 8 L4 12 z" fill="rgba(255,255,255,0.9)" />
              </marker>
              <filter id="glow">
                <feGaussianBlur stdDeviation="3" result="coloredBlur"/>
                <feMerge> 
                  <feMergeNode in="coloredBlur"/>
                  <feMergeNode in="SourceGraphic"/>
                </feMerge>
              </filter>
            </defs>
          </svg>

          <!-- Enhanced Squirrel Character with Fixed Tail -->
          <div id="squirrel" class="squirrel" style="left:50px; top:25px;">
            <svg viewBox="0 0 200 200" width="100" height="100">
              <!-- Enhanced Body with gradient -->
              <defs>
                <linearGradient id="bodyGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                  <stop offset="0%" stop-color="#A0522D"/>
                  <stop offset="100%" stop-color="#8B4513"/>
                </linearGradient>
                <linearGradient id="tailGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                  <stop offset="0%" stop-color="#8B4513"/>
                  <stop offset="100%" stop-color="#654321"/>
                </linearGradient>
                <filter id="squirrelShadow">
                  <feDropShadow dx="2" dy="4" stdDeviation="3" flood-color="#000000" flood-opacity="0.3"/>
                </filter>
              </defs>
              
              <g filter="url(#squirrelShadow)">
                <!-- Fixed Fluffy Tail - Better positioned -->
                <g class="tail" transform="translate(120,40)">
                  <path d="M0,0 Q30,-20 50,10 Q70,40 30,50 Q10,35 0,15 Z" fill="url(#tailGrad)"/>
                  <path d="M8,12 Q35,0 42,25 Q48,45 32,48 Q18,42 15,28 Z" fill="#A0522D" opacity="0.8"/>
                </g>
                
                <!-- Body -->
                <ellipse cx="100" cy="135" rx="35" ry="28" fill="url(#bodyGrad)"/>
                <ellipse cx="100" cy="95" rx="38" ry="35" fill="url(#bodyGrad)"/>
                
                <!-- Head -->
                <circle cx="100" cy="75" r="28" fill="url(#bodyGrad)"/>
                
                <!-- Enhanced Ears -->
                <circle cx="82" cy="60" r="10" fill="url(#bodyGrad)"/>
                <circle cx="118" cy="60" r="10" fill="url(#bodyGrad)"/>
                <circle cx="80" cy="58" r="5" fill="#DEB887"/>
                <circle cx="116" cy="58" r="5" fill="#DEB887"/>
                
                <!-- Sparkling Eyes -->
                <circle cx="90" cy="75" r="6" fill="#0f172a"/>
                <circle cx="110" cy="75" r="6" fill="#0f172a"/>
                <circle cx="88" cy="73" r="2" fill="#f1f5f9"/>
                <circle cx="108" cy="73" r="2" fill="#f1f5f9"/>
                <circle cx="92" cy="72" r="1" fill="#f59e0b"/>
                <circle cx="112" cy="72" r="1" fill="#f59e0b"/>
                
                <!-- Nose -->
                <circle cx="100" cy="85" r="4" fill="#5C3317"/>
                
                <!-- Cheeks -->
                <circle cx="82" cy="85" r="8" fill="#CD853F" opacity="0.6"/>
                <circle cx="118" cy="85" r="8" fill="#CD853F" opacity="0.6"/>
                
                <!-- Paws -->
                <circle cx="82" cy="150" r="8" fill="url(#bodyGrad)"/>
                <circle cx="118" cy="150" r="8" fill="url(#bodyGrad)"/>
                
                <!-- Belly -->
                <ellipse cx="100" cy="125" rx="18" ry="22" fill="#DEB887"/>
                
                <!-- Golden Acorn -->
                <ellipse cx="72" cy="120" rx="10" ry="12" fill="#f59e0b"/>
                <ellipse cx="72" cy="112" rx="6" ry="5" fill="#d97706"/>
                <path d="M65,125 Q72,135 79,125" fill="#8B4513"/>
              </g>
            </svg>
          </div>

          <!-- speech bubble -->
          <div id="speech" class="speech" aria-hidden="true">√ó100</div>
        </div>
      </div>

      <div class="right">
        <div class="panel">
          <div class="panel-title">Konversi Metrik</div>
          <div class="controls">
            <label for="fromSelect">Dari</label>
            <select id="fromSelect" aria-label="Satuan awal">
              <option>km</option><option>hm</option><option>dam</option><option selected>m</option><option>dm</option><option>cm</option><option>mm</option>
            </select>

            <label for="toSelect">Ke</label>
            <select id="toSelect" aria-label="Satuan tujuan">
              <option>km</option><option>hm</option><option>dam</option><option>m</option><option>dm</option><option selected>cm</option><option>mm</option>
            </select>

            <button id="convertBtn" class="primary">Mulai Petualangan!</button>
          </div>

          <div style="margin-top:16px;font-size:13px;color:#94a3b8;line-height:1.5;">
            Perhatikan Tupai menjelajahi tangga metrik! Setiap lompatan mengungkap faktor konversi dengan animasi bersinar dan transisi halus.
          </div>
        </div>

        <div style="height:16px"></div>

        <div class="panel">
          <div class="panel-title">Misi Cepat</div>
          <div style="display:flex;flex-direction:column;gap:10px">
            <button id="quick_mc" class="quick-btn">m ‚Üí cm (√ó100)</button>
            <button id="quick_cm" class="quick-btn">cm ‚Üí m (√∑100)</button>
            <button id="quick_km_m" class="quick-btn">km ‚Üí m (√ó1000)</button>
            <button id="resetBtn" class="reset-btn">Reset Petualangan</button>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
// Add this script to ensure images load properly
document.addEventListener('DOMContentLoaded', function() {
  // Force load lazy images in secondary header
  const lazyImages = document.querySelectorAll('.secondaryHeader .lazy');
  lazyImages.forEach(img => {
    img.classList.add('loaded');
    img.style.opacity = '1';
    img.style.visibility = 'visible';
    img.style.display = 'block';
  });
});

/* Enhanced Gaming JS with fixed bubble positioning */
(function(){
  const unitOrder = ['km','hm','dam','m','dm','cm','mm'];
  const steps = Array.from(document.querySelectorAll('.step'));
  const svg = document.getElementById('svgLayer');
  const stairArea = document.getElementById('stairArea');
  const squirrel = document.getElementById('squirrel');
  const speech = document.getElementById('speech');
  let running = false;

  // Enhanced audio context for better sounds
  let audioContext = null;
  
  function playHopSound() {
    try {
      if (!audioContext) {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
      }
      
      // Create multiple oscillators for richer sound
      const oscillator1 = audioContext.createOscillator();
      const oscillator2 = audioContext.createOscillator();
      const gainNode = audioContext.createGain();
      
      oscillator1.connect(gainNode);
      oscillator2.connect(gainNode);
      gainNode.connect(audioContext.destination);
      
      // Dual oscillator for richer sound
      oscillator1.type = 'sine';
      oscillator2.type = 'triangle';
      oscillator1.frequency.setValueAtTime(400, audioContext.currentTime);
      oscillator2.frequency.setValueAtTime(300, audioContext.currentTime);
      oscillator1.frequency.exponentialRampToValueAtTime(200, audioContext.currentTime + 0.25);
      oscillator2.frequency.exponentialRampToValueAtTime(150, audioContext.currentTime + 0.25);
      
      gainNode.gain.setValueAtTime(0.15, audioContext.currentTime);
      gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.25);
      
      oscillator1.start(audioContext.currentTime);
      oscillator2.start(audioContext.currentTime);
      oscillator1.stop(audioContext.currentTime + 0.25);
      oscillator2.stop(audioContext.currentTime + 0.25);
      
    } catch (error) {
      console.log('Audio not supported:', error);
    }
  }

  function refreshSvg(){
    const r = stairArea.getBoundingClientRect();
    svg.setAttribute('width', r.width);
    svg.setAttribute('height', r.height);
    svg.setAttribute('viewBox', `0 0 ${r.width} ${r.height}`);
  }

  function cornerOf(el, position){
    const pr = stairArea.getBoundingClientRect();
    const r = el.getBoundingClientRect();
    const offsetX = r.left - pr.left;
    const offsetY = r.top - pr.top;
    
    switch(position) {
      case 'top-left':
        return { x: offsetX + 15, y: offsetY + 15 };
      case 'top-right':
        return { x: offsetX + r.width - 15, y: offsetY + 15 };
      case 'bottom-left':
        return { x: offsetX + 15, y: offsetY + r.height - 15 };
      case 'bottom-right':
        return { x: offsetX + r.width - 15, y: offsetY + r.height - 15 };
      default:
        return { x: offsetX + r.width/2, y: offsetY + r.height/2 };
    }
  }

  function makeStairPath(fromEl, toEl, directionDown){
    const fromEnd = cornerOf(fromEl, directionDown ? 'bottom-right' : 'top-right');
    const toStart = cornerOf(toEl, directionDown ? 'top-left' : 'bottom-left');
    
    if (directionDown) {
      const midY = (fromEnd.y + toStart.y) / 2;
      return `M ${fromEnd.x} ${fromEnd.y} 
              L ${fromEnd.x + 50} ${fromEnd.y}
              L ${fromEnd.x + 50} ${midY}
              L ${toStart.x - 50} ${midY}
              L ${toStart.x - 50} ${toStart.y}
              L ${toStart.x} ${toStart.y}`;
    } else {
      const midY = (fromEnd.y + toStart.y) / 2;
      return `M ${fromEnd.x} ${fromEnd.y} 
              L ${fromEnd.x + 50} ${fromEnd.y}
              L ${fromEnd.x + 50} ${midY}
              L ${toStart.x - 50} ${midY}
              L ${toStart.x - 50} ${toStart.y}
              L ${toStart.x} ${toStart.y}`;
    }
  }

  function createArrow(fromEl, toEl, opText, directionDown=true){
    const d = makeStairPath(fromEl, toEl, directionDown);
    const ns = "http://www.w3.org/2000/svg";
    const path = document.createElementNS(ns,'path');
    path.setAttribute('d', d);
    path.setAttribute('class','curve draw');
    path.setAttribute('stroke','rgba(255,255,255,0.9)');
    path.setAttribute('fill','none');
    path.setAttribute('marker-end','url(#arrHead)');
    path.setAttribute('filter','url(#glow)');
    svg.appendChild(path);

    const label = document.createElement('div');
    label.className = 'op-label';
    label.textContent = opText;
    stairArea.appendChild(label);

    let mid;
    try {
      const len = path.getTotalLength();
      mid = path.getPointAtLength(len*0.5);
    } catch(e) {
      const fromEnd = cornerOf(fromEl, directionDown ? 'bottom-right' : 'top-right');
      const toStart = cornerOf(toEl, directionDown ? 'top-left' : 'bottom-left');
      mid = { x:(fromEnd.x+toStart.x)/2, y:(fromEnd.y+toStart.y)/2 };
    }
    
    label.style.left = mid.x + 'px';
    label.style.top  = (mid.y - (directionDown ? 25 : -25)) + 'px';
    
    return { path, label };
  }

  function animateSingle(arrowObj, drawMs=1200, pauseMs=800){
    return new Promise((resolve)=>{
      const { path, label } = arrowObj;
      const len = path.getTotalLength();
      path.style.strokeDasharray = len;
      path.style.strokeDashoffset = len;
      
      requestAnimationFrame(()=> path.style.strokeDashoffset = '0');
      
      setTimeout(()=> {
        label.classList.add('show');
        setTimeout(()=> resolve(), pauseMs);
      }, drawMs);
    });
  }

  function moveSquirrelTo(index){
    const target = steps[index];
    const srect = stairArea.getBoundingClientRect();
    const tred = target.getBoundingClientRect();
    const left = tred.left - srect.left + tred.width/2 - (squirrel.offsetWidth/2);
    const top  = tred.top - srect.top - (squirrel.offsetHeight * 0.7);
    squirrel.style.left = left + 'px';
    squirrel.style.top  = top  + 'px';

    // Update speech bubble position immediately
    updateSpeechPosition();

    squirrel.classList.remove('hop');
    void squirrel.offsetWidth;
    squirrel.classList.add('hop');

    playHopSound();

    const tail = squirrel.querySelector('.tail');
    if(tail){
      tail.style.animation = 'tailWiggle 700ms ease';
      setTimeout(()=> tail.style.animation = '', 700);
    }
  }

  function updateSpeechPosition(){
    const pRect = squirrel.getBoundingClientRect();
    const sRect = stairArea.getBoundingClientRect();
    speech.style.left = (pRect.left - sRect.left + pRect.width/2) + 'px';
    speech.style.top  = (pRect.top - sRect.top - 45) + 'px';
  }

  function formatFactor(n){
    return (n >= 1000) ? n.toLocaleString() : n.toString();
  }

  async function runSequence(fromUnit, toUnit){
    if(running) return;
    running = true;
    
    svg.querySelectorAll('path').forEach(n => n.remove());
    stairArea.querySelectorAll('.op-label').forEach(n => n.remove());
    speech.classList.remove('show');

    const fromIdx = unitOrder.indexOf(fromUnit);
    const toIdx   = unitOrder.indexOf(toUnit);
    if(fromIdx === toIdx){ alert('Pilih dua satuan yang berbeda untuk petualangan!'); running=false; return; }

    const diff = toIdx - fromIdx;
    const down = diff > 0;
    const stepsCount = Math.abs(diff);
    const totalPower = Math.pow(10, stepsCount);

    moveSquirrelTo(fromIdx);
    await new Promise(r => setTimeout(r, 200));

    if(down){
      for(let i=fromIdx; i<toIdx; i++){
        const arrow = createArrow(steps[i], steps[i+1], '√ó10', true);
        await animateSingle(arrow, 1200, 800);
        moveSquirrelTo(i+1);
        await new Promise(r=>setTimeout(r, 300));
      }
    } else {
      for(let i=fromIdx; i>toIdx; i--){
        const arrow = createArrow(steps[i], steps[i-1], '√∑10', false);
        await animateSingle(arrow, 1200, 800);
        moveSquirrelTo(i-1);
        await new Promise(r=>setTimeout(r, 300));
      }
    }

    speech.textContent = down ? `√ó${formatFactor(totalPower)}` : `√∑${formatFactor(totalPower)}`;
    speech.classList.add('show');
    // Ensure bubble position is updated after movement
    setTimeout(updateSpeechPosition, 50);

    running = false;
  }

  async function quickJump(fromUnit, toUnit){
    if(running) return;
    running = true;
    svg.querySelectorAll('path').forEach(n => n.remove());
    stairArea.querySelectorAll('.op-label').forEach(n => n.remove());
    speech.classList.remove('show');

    const fromIdx = unitOrder.indexOf(fromUnit);
    const toIdx   = unitOrder.indexOf(toUnit);
    const diff = toIdx - fromIdx;
    if(diff === 0){ running=false; return; }
    const down = diff > 0;
    const stepsCount = Math.abs(diff);
    const power = Math.pow(10, stepsCount);

    moveSquirrelTo(fromIdx);
    await new Promise(r=>setTimeout(r, 150));

    const arrow = createArrow(steps[fromIdx], steps[toIdx], down ? `√ó${power}` : `√∑${power}`, down);
    await animateSingle(arrow, 1200, 900);
    moveSquirrelTo(toIdx);
    await new Promise(r=>setTimeout(r, 150));

    speech.textContent = down ? `√ó${formatFactor(power)}` : `√∑${formatFactor(power)}`;
    speech.classList.add('show');
    // Fix: Update speech position after quick jump
    setTimeout(updateSpeechPosition, 100);

    running = false;
  }

  // UI wiring
  document.getElementById('convertBtn').addEventListener('click', ()=>{
    const from = document.getElementById('fromSelect').value;
    const to   = document.getElementById('toSelect').value;
    runSequence(from, to);
  });
  document.getElementById('quick_mc').addEventListener('click', ()=> quickJump('m','cm'));
  document.getElementById('quick_cm').addEventListener('click', ()=> quickJump('cm','m'));
  document.getElementById('quick_km_m').addEventListener('click', ()=> quickJump('km','m'));
  document.getElementById('resetBtn').addEventListener('click', ()=>{
    svg.querySelectorAll('path').forEach(n => n.remove());
    stairArea.querySelectorAll('.op-label').forEach(n => n.remove());
    speech.classList.remove('show');
    moveSquirrelTo(0);
    // Update speech position after reset
    setTimeout(updateSpeechPosition, 100);
  });

  // Enhanced initialization
  window.addEventListener('resize', ()=> {
    refreshSvg();
    svg.querySelectorAll('path').forEach(n => n.remove());
    stairArea.querySelectorAll('.op-label').forEach(n => n.remove());
    speech.classList.remove('show');
    moveSquirrelTo(0);
    setTimeout(updateSpeechPosition, 100);
  });

  refreshSvg();
  moveSquirrelTo(0);
  // Initialize speech bubble position
  setTimeout(updateSpeechPosition, 100);
  
  // Add some initial sparkle to steps
  steps.forEach((step, index) => {
    setTimeout(() => {
      step.style.transform = 'scale(1.05)';
      setTimeout(() => step.style.transform = 'scale(1)', 200);
    }, index * 100);
  });
})();
</script>
</body>
</html>